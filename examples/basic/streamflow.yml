version: v1.0
workflows:
  master:
    type: cwl
    config:
      file: main.cwl
      settings: inputs.yml
    bindings:
      - step: /step1
        target:
          deployment: local-deploy
      - step: /step2_1
        target:
          deployment: venv-deploy
      - step: /step2_2
        target:
          deployment: venv-deploy
      - step: /step2_3
        target:
          deployment: venv-deploy
      - step: /step3
        target:
          deployment: local-deploy

deployments:
  local-deploy:
    type: local
    config: {}

  ssh-deploy:
    type: ssh
    workdir: /beegfs/home/tommaso.fogliobonda/tmp/streamflow
    config:
      nodes:
        - c3sfr1.di.unito.it
      username: tommaso.fogliobonda
      sshKey: ~/.ssh/unito/hpc
      checkHostKey: false

  slurm-deploy:
    type: slurm
    wraps: ssh-deploy
    workdir: /beegfs/home/tommaso.fogliobonda/tmp/streamflow
    config:
      services:
        broadwell:
          partition: broadwell

  venv-deploy:
    type: pyvenv
    wraps: 
      deployment: slurm-deploy
      service: broadwell
    config:
      path: /beegfs/home/tommaso.fogliobonda/tmp/1000genome-venv
      random-suffix: false
      force-install: true
      keep-venv: true
      requirements:
        - cowsay